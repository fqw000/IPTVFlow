name: ğŸ“º daily-IPTVFlowList-refresh

on:
  schedule:
    - cron: '15 1 * * *'  # UTC 01:15 â†’ åŒ—äº¬æ—¶é—´ 09:15
  workflow_dispatch:

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # å¢åŠ è‡³ 20 åˆ†é’Ÿï¼ˆOCR å¯èƒ½è¾ƒæ…¢ï¼‰

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸ”„ Sync with remote (rebase)
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git pull --rebase origin main || echo "âœ… Already up-to-date"

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # âœ… å®‰è£…åŸºç¡€ä¾èµ–
      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install requests

      # âœ… ã€å¯é€‰ã€‘å®‰è£… FFmpegï¼ˆç”¨äºæ·±åº¦éªŒè¯ï¼‰
      - name: ğŸï¸ Install FFmpeg (for stream validation)
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      # âœ… ã€å¯é€‰ã€‘å®‰è£… Tesseract + OCR ä¾èµ–ï¼ˆç”¨äºç”»é¢æ£€æµ‹ï¼‰
      - name: ğŸ” Install Tesseract OCR (optional, for soft-error detection)
        run: |
          sudo apt-get install -y tesseract-ocr libtesseract-dev
          pip install pytesseract opencv-python pillow

      # âœ… å…³é”®ï¼šåœ¨æ­£ç¡®ç›®å½•ä¸‹è¿è¡Œè„šæœ¬
      - name: ğŸ§¹ Run IPTV Cleaner (Enhanced Version)
        run: |
          python clean_iptv.py  # ğŸ‘ˆ ç¡®ä¿æ–‡ä»¶ååŒ¹é…ï¼
        env:
          # å¦‚æœä½ è„šæœ¬é‡Œå¯ç”¨äº† BARK æ¨é€ï¼Œä¿ç•™ï¼›å¦åˆ™å¯åˆ ã€‚é»˜è®¤å¯ç”¨
          BARK_DEVICE_KEY: ${{ secrets.BARK_DEVICE_KEY }}

      # âœ… å…³é”®ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äºä»“åº“æ ¹ç›®å½•çš„è·¯å¾„
      - name: ğŸ“¤ Commit and push if changed
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ³¨æ„ï¼šè·¯å¾„æ˜¯ç›¸å¯¹äºä»“åº“æ ¹ç›®å½•
          git add live_clean.m3u report.md
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes â€” skipping commit."
            exit 0
          fi
          
          echo "âœ… Changes detected. Committing..."
          git commit -m "chore(iptv): auto-update clean playlist [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git push origin main
          echo "ğŸ“¤ Push successful"

      # ğŸ è°ƒè¯•ï¼šä¸Šä¼ å¯èƒ½çš„ debug æ–‡ä»¶ï¼ˆå¦‚æœè„šæœ¬ç”Ÿæˆäº†ï¼‰
      - name: ğŸ“¦ Upload debug artifacts (if any)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: iptv-debug-files
          path: clean_iptv/debug_*
          retention-days: 3
